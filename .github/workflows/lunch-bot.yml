name: Lunch Bot

on:
  schedule:
    # í•œêµ­ì‹œê°„ 10:00 (UTC 01:00)
    - cron: '0 1 * * 1-5'
    # í•œêµ­ì‹œê°„ 11:00 (UTC 02:00)
    - cron: '0 2 * * 1-5'

  # ìˆ˜ë™ ì‹¤í–‰ìš©
  workflow_dispatch:
    inputs:
      action:
        description: 'ì‹¤í–‰í•  ë™ì‘ ì„ íƒ'
        required: true
        default: 'start'
        type: choice
        options:
          - start
          - draw

jobs:
  start-lottery:
    name: ğŸ¯ Start Lottery (10:00)
    runs-on: ubuntu-latest
    # ì¡°ê±´: ìˆ˜ë™ ì‹¤í–‰ì—ì„œ start ì„ íƒ OR ìŠ¤ì¼€ì¤„ ì´ë²¤íŠ¸
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'start' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run start_lottery.py
        env:
          SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
          TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
        run: |
          # í˜„ì¬ UTC ì‹œê°„ì´ 1ì‹œì¼ ë•Œë§Œ (KST 10ì‹œ)
          hour=$(date -u +"%H")
          if [ "$hour" = "01" ]; then
            echo "â° It's 10AM KST, running start_lottery.py..."
            python start_lottery.py
          elif [ "${{ github.event.inputs.action }}" = "start" ]; then
            echo "Manual trigger: running start_lottery.py..."
            python start_lottery.py
          else
            echo "â© Skipping start_lottery.py (not the right time)"
          fi

  draw-lottery:
    name: ğŸ² Draw Lottery (11:00)
    runs-on: ubuntu-latest
    # ì¡°ê±´: ìˆ˜ë™ ì‹¤í–‰ì—ì„œ draw ì„ íƒ OR ìŠ¤ì¼€ì¤„ ì´ë²¤íŠ¸
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'draw' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run draw_lottery.py
        env:
          SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
          TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
        run: |
          # í˜„ì¬ UTC ì‹œê°„ì´ 2ì‹œì¼ ë•Œë§Œ (KST 11ì‹œ)
          hour=$(date -u +"%H")
          if [ "$hour" = "02" ]; then
            echo "â° It's 11AM KST, running draw_lottery.py..."
            python draw_lottery.py
          elif [ "${{ github.event.inputs.action }}" = "draw" ]; then
            echo "Manual trigger: running draw_lottery.py..."
            python draw_lottery.py
          else
            echo "â© Skipping draw_lottery.py (not the right time)"
          fi
